<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="description" content="GeoNarrative Template" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>GeoNarrative Template</title>
  <!-- <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,400;0,500;1,400;1,500&display=swap" /> -->
  <!-- <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css"> -->
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"> -->
  <link rel="stylesheet" href="css/main.css">
  <script src="https://unpkg.com/scrollama"></script>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>
</head>

<body>
  <!-- loading a video cover page -->
  <section id="cover">
    <!-- loading a video as the background -->
    <video class="fullscreen canvas-center" playsinline="" autoplay="" muted="" loop="">
      <source src="assets/Covid.mp4" type="video/mp4">
    </video>
    <div id="intro">
      <h1>GEOG 458 Final Project</h1>
      <h5>COVID-19 Mapping in the U.S.</h5>
      <p>This storytelling map shows COVID-19 data across the U.S. using data from the Ney York Times
        to get total COVID-19 counts for all states. We are going to examine the covid trends of 
      </p>

      <div class="footnote">
        <span> To access COVID-19 data click on NYT logo</span>
        <a target="_blank" href="https://github.com/nytimes/covid-19-data"> <img src="img/NYT.jpg" width="50px"></a>
      </div>
    </div>
  </section>
  <!-- a geonarrative will have two major components, a storyboard and a script panel of a series of scenes/actions -->
  <section id="geonarrative">
    <!-- a storymap can present differnt types of objects, like map, chart, diagram, etc. -->
    <div id="storyboard">
      <!-- create the place holder element for map -->
      <div id="map"></div>
    </div>

    <article class="scene" data-scene="0">
      <h2>First State: Washington</h2>
        <p>Overview </p>
          <div style="font-size: xx-large;";>
            <!-- loading bootstrap icons -->
            <p><i class="bi bi-person"></i> <span>1,924,418 Total Cases</span>
            </p>
            <p><i class="bi bi-hospital"></i> <span>19.70 Deaths per 10k</span>
            </p>
          </div>
      <p> Maybe include a picture of a graph </p>
    </article>
    <article class="scene" data-scene="1">
      <h2>Second State: Georgia</h2>
        <div style="font-size: xx-large;";>
          <!-- loading bootstrap icons -->
          <p><i class="bi bi-person"></i> <span>2,972,781 Total Cases</span>
          </p>
          <p><i class="bi bi-hospital"></i> <span>36.92 Deaths per 10k</span>
          </p>
        </div>
        <p> Maybe include a picture of a graph </p>
  </article>
    <article class="scene" data-scene="2">
      <h2>Third State: New York</h2>
        <div style="font-size: xx-large;";>
          <!-- loading bootstrap icons -->
          <p><i class="bi bi-person"></i> <span> 6,764,874 Total Cases</span>
          </p>
          <p><i class="bi bi-hospital"></i> <span> 40.48 Deaths per 10k</span>
          </p>
        </div>
        <p> Maybe include a picture of a graph </p>
    </article>
  <article class="scene" data-scene="3">
      <h2>Final State: Flordia</h2>

      <div style="font-size: xx-large;";>
        <!-- loading bootstrap icons -->
        <p><i class="bi bi-person"></i> <span> 7,473,371 Total Cases</span>
        </p>
        <p><i class="bi bi-hospital"></i> <span> 38.16 Deaths per 10k</span>
        </p>
      </div>
      <p> Maybe include a picture of a graph </p>
    </article>
    
  <article class="scene" data-scene="4">
      <h2>A Closer Look: Washington</h2>
      <h3> Hover over a County for more Info! </h3>
      <p> The first state that we are going to examine for covid cases is Washington. Washington state implemented a series of measures to combat the spread of Covid-19, particularly in the early stages of the pandemic.
        Being one of the first states to experience an outbreak, a state of emergency was declared in Feburary of 2020 by Governer Jay Inslee. 
        This quickly turned into a Stay-at-Home Order and closure of all non-essential buisnesses. This was combined with indoor and outdoor mask mandates
        to try and help ease the spread. Washington continued this lock-down for a longer time until Phased Reopening was introduced along with contact tracing and 
        early vaccination mandates to help reduce the spread.
      </p>
    
  </article>
    <article class="scene" data-scene="5">
      <h2>A Closer Look: Georgia</h2>
      <h3> Hover over a County for more Info! </h3>
      <p> New York had become one of the early epicenters of the pandemic and gained national attention as they quickly experienced overwhealmed hospitals and medical shortages.
        As a reponse to this, the governer implemented strict lockdown measures similar to that of Washington, such as stay-at-home orders and closure of buisnesses and 
        more intense social distancing guidelines. Due to the high concentration of people, the city had to set up field hospitals and recurit outside healthcare aid to help
        curb the influx of cases the state was experiencing. The state saw intense lockdown measures combined with aggressive testing and a strong push for vaccination, helping
        mitigate the spread of the virus throughout the city. 
      </p>
      
    </article>
    <article class="scene" data-scene="6">
      <h2>A Closer Look: New York</h2>
      <h3> Hover over a County for more Info! </h3>
      <p> New York had become one of the early epicenters of the pandemic and gained national attention as they quickly experienced overwhealmed hospitals and medical shortages.
        As a reponse to this, the governer implemented strict lockdown measures similar to that of Washington, such as stay-at-home orders and closure of buisnesses and 
        more intense social distancing guidelines. Due to the high concentration of people, the city had to set up field hospitals and recurit outside healthcare aid to help
        curb the influx of cases the state was experiencing. The state saw intense lockdown measures combined with aggressive testing and a strong push for vaccination, helping
        mitigate the spread of the virus throughout the city. 
      </p>
    </article>
    <article class="scene" data-scene="7">
      <h2>A Closer Look: Florida </h2>
      <h3> Hover over a County for more Info! </h3>
      <p> Flordia's policies and actions featued those very similar to Georgia. They followed a similar plan or early reopening, allowing
        buisnesses and public spaces to reopen in May of 2020. They also took their time when it came to a mask mandate, not opting to install
        one until September of 2020. The governer faced harsh criticts that believed the actions and polocies were not strict enough in order to
        help prevent the spread of covid and limit the death count.
      </p>
    </article>
    <article class="scene" data-scene="8">
      <h2>Overall Trends and Findings</h2>
      <p> After looking at these 4 states with different measures and ideologies on dealing with the pandemic, it is clear that...
      </p>
    </article>

  </section>

  <section id="footer">
    <h2>FOOTER</h2>
  </section>


  <script>
    // 1. Declare the maps, script panels, and different thematic layers.
    let map, scriptPanel = scrollama(), stateLayer, countyLayer;

    // 2. Intialize the layout.
   
    history.scrollRestoration = "manual"; // make sure the geo-narrative will be scrolled to the cover page even after a page refresh.
    window.scrollTo(0, 0); // scroll the geo-narrative to the coverpage
    adjustStoryboardlSize(); // force a browser window resize.
    window.addEventListener("resize", adjustStoryboardlSize); // // ask the browser window listen to the resize event, thereby force a viewport resize whenever adjusting the window size.

    // 3. Define Generic window resize listener event
    function adjustStoryboardlSize() {

      const scenes = document.getElementsByClassName("scene");
      const storyboard = document.getElementById("storyboard");

      // 3.1 determine the height of each scene element
      let sceneH = Math.floor(window.innerHeight * 0.75);
      for (const scene of scenes) {
        scene.style.height = sceneH + "px";
      }
      
      // 3.2 determin the height of the storyboard.
      let storyboardHeight = window.innerHeight;
      let storyboardMarginTop = (window.innerHeight - storyboardHeight) / 2;

      storyboard.style.height = storyboardHeight + "px";
      storyboard.style.top = storyboardMarginTop + "px"

      // 3.3 tell scrollama/script panel to update new element dimensions
      scriptPanel.resize();
    }

    // 4. Initialize the mapbox
    mapboxgl.accessToken =
      'pk.eyJ1IjoiamFrb2J6aGFvIiwiYSI6ImNpcms2YWsyMzAwMmtmbG5icTFxZ3ZkdncifQ.P9MBej1xacybKcDN_jehvw'; // Assign the access token
   
    map = new mapboxgl.Map({
      container: 'map', // container ID
      style: 'mapbox://styles/mapbox/light-v10',
      zoom: 4, // starting zoom
      minZoom: 1,
      maxZoom: 10,
      center: [-98.93, 40.33], // starting center
      scrollZoom: false,
      boxZoom: false,
      doubleClickZoom: false
    });  // Declare the map object

    // An alternative way to disable map zoom when using scroll
    // map.scrollZoom.disable();


    // 5. define the asynchronous function to load geojson data and then performs the dependent actions.
    async function geojsonFetch() {

      // 6 wait till the data of washington state and county are fully loaded.
      let response, state, county;
      response = await fetch("assets/state_data.geojson");
      state = await response.json();
      response = await fetch("assets/us-covid-2020-rates.json");
      county = await response.json();


      // 7. Trigger operations inside of the the ()=> {} funciton while loading the map.
      map.on('load', () => {

        // 8. add map source and declare layers.
        map.addSource('county-src', {
          type: 'geojson',
          data: county
        });

        map.addSource('state-src', {
          type: 'geojson',
          data: state
        });

        stateLayer = {
          'id': 'state-polygons',
          'type': 'fill',
          'source': 'state-src',
          'minzoom': 5,
          'paint': {
            'fill-color': '#0080ff',
            'fill-opacity': 0.5
          }
        };

        countyLayer = {
          'id': 'county-points',
          'type': 'fill',
          'source': 'county-src',
          'minzoom': 3,
          'paint': {
            'fill-color': 'red',
            'fill-opacity': 0.5
          }
        };

        // 9. Initialize the script panel
        scriptPanel
          .setup({
            step: ".scene", // all the scenes.
            offset: 0.33, // the location of the enter and exit trigger
            debug: false // toggler on or off the debug mode.
          })
          .onStepEnter(handleSceneEnter)
          .onStepExit(handleSceneExit);
        
        // 10. This function performs when a scene enters the storyboard
        function handleSceneEnter(response) {

          var index = response.index; // capture the id of the current scene. 

          if (index === 0) { // When enter the first scene

            map.flyTo({
              center: [-123.93, 47.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            }); // fly to a new location
            
            if (typeof (map.getSource('state-src')) == 'undefined') { //if the map source 'state-src' does not exist
              map.addSource('state-src', {
                type: 'geojson',
                data: state
              }); // reload the map source of 'state-src'
            } else {
              map.getSource('state-src').setData(state); // if the map source does not exist, relaod the data state to the pre-defined map source 'state-src'.
            }

            if (!map.getLayer("state-polygons")) { // if the map layer 'state-polygons' does not exit
              map.addLayer(stateLayer);
            }
            document.getElementById("cover").style.visibility = "hidden"; // Hide the cover page

          } else if (index === 1) { // When enter the second scene.
            map.flyTo({
              center: [-84.93, 32.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            });

          } else if (index === 2) {
            map.flyTo({
              center: [-78.93, 43.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            });
            //Relocate to Seattle

          } else if (index === 3) {
            //Relocate to Portland
            map.flyTo({
              center: [-83.93, 27.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            });
             // change the base map
          } else if (index === 4) {

            map.flyTo({
              center: [-123.93, 47.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            }); 

            if (typeof (map.getSource('county-src')) == 'undefined') {
              map.addSource('county-src', {
                type: 'geojson',
                data: county
              });
            } else {
              map.getSource('county-src').setData(county);

            }

            if (!map.getLayer("county-points")) {
              map.addLayer(countyLayer);
            }

          }else if (index === 5) {
            map.flyTo({
              center: [-84.93, 32.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            });

          } else if (index === 6) {
            map.flyTo({
              center: [-78.93, 43.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            });
            
          } else if (index === 7) {
            map.flyTo({
              center: [-83.93, 27.33],
              zoom: 6,
              pitch: 0,
              speed: 0.5
            });

            
          } else if (index === 8) {
            map.flyTo({
              center: [-98.93, 40.33],
              zoom: 4,
              pitch: 0,
              speed: 0.5
            });
            if (map.getLayer("county-points")) {
                map.removeLayer('county-points');
            }
            
          }
        }

        // 11. This function performs when a scene exists the storyboard
        function handleSceneExit(response) {
          var index = response.index;

          if (index === 0) {

            if (response.direction == 'down') { 
              document.getElementById("cover").style.visibility = "hidden"; // when you scroll down, the cover page will be hided.
            } else {
              document.getElementById("cover").style.visibility = "visible"; // when you scroll up, the cover page will be shown.
            }
          } else if (index === 1) {
        
          } else if (index === 3) {
            if (response.direction == 'down') { 
              if (map.getLayer("state-polygons")) {
                map.removeLayer('state-polygons');
              } 
            }
              
          } else if (index === 4) {
            if (response.direction == 'up') { 
              if (map.getLayer("county-points")) {
                map.removeLayer('county-points');
              }
              if (typeof (map.getSource('state-src')) == 'undefined') { //if the map source 'state-src' does not exist
              map.addSource('state-src', {
                type: 'geojson',
                data: state
              }); // reload the map source of 'state-src'
              } else {
                map.getSource('state-src').setData(state); // if the map source does not exist, relaod the data state to the pre-defined map source 'state-src'.
              }

              if (!map.getLayer("state-polygons")) { // if the map layer 'state-polygons' does not exit
                map.addLayer(stateLayer);
              }
            }              
          } else if (index === 8) {
            if (response.direction == 'up') { 
              if (typeof (map.getSource('county-src')) == 'undefined') {
              map.addSource('county-src', {
                type: 'geojson',
                data: county
              });
            } else {
              map.getSource('county-src').setData(county);

            }

            if (!map.getLayer("county-points")) {
              map.addLayer(countyLayer);
            }


            }
          }



        }


      });

      
      
      
      map.on('mousemove', ({ point }) => {
        const features = map.queryRenderedFeatures(point, {
            layers: ['state-polygons']
        });

        if (features.length) {
            const name = features[0].properties.name;
            const cases = features[0].properties.cases;

            // Display tooltip with county name and cases
            document.getElementById('textid').innerHTML = `<h3>${name}</h3><p><strong><em>${cases}</strong> Covid-19 cases per State</em></p>`;
        } else {
            // Hide tooltip if not hovering over a county
            document.getElementById('textid').innerHTML = '';
        }
    });
      
      
      
      
      
      map.on('mousemove', ({ point }) => {
        const features = map.queryRenderedFeatures(point, {
            layers: ['county-points']
        });

        if (features.length) {
            const county = features[0].properties.county;
            const cases = features[0].properties.cases;

            // Display tooltip with county name and cases
            document.getElementById('tooltip').innerHTML = `<h3>${county}</h3><p><strong><em>${cases}</strong> Covid-19 cases per county in the U.S.</em></p>`;
        } else {
            // Hide tooltip if not hovering over a county
            document.getElementById('tooltip').innerHTML = '';
        }
    });

    };

    // 5 call the data loading function.
    geojsonFetch();
  </script>
</body>

</html>
